<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>컬러 가이드 - AI 퍼스널 컬러 어드바이저</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="animated-bg">
        {% include 'navigation.html' %}
        <div id="guide" class="page-section active">
            <div class="container" style="padding-top: 100px;">
                <div class="guide-header">
                    <h1>🎨 컬러 가이드</h1>
                    <p class="subtitle">
                        각 퍼스널 컬러 타입에 대한 상세 정보와 스타일링 팁을 확인해보세요.<br>
                        카드를 클릭하면 상세 컬러 팔레트를 볼 수 있습니다.
                    </p>
                </div>
                <div id="color-guide-container" class="color-guide-grid">
                    <!-- Color cards will be dynamically generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Template for color cards -->
    <template id="color-card-template">
        <div class="color-card">
            <div class="color-card-header">
                <div class="color-card-preview"></div>
                <div class="color-card-title">
                    <h2></h2>
                    <p></p>
                </div>
                <div class="color-card-toggle">
                    <span>+</span>
                </div>
            </div>
            <div class="color-card-details"></div>
        </div>
    </template>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const descriptions = {
            "Golden": "따뜻하고 활기찬 골드 계열 컬러가 어울리며, 밝고 화사한 인상을 줍니다.",
            "Warm Beige": "부드러운 베이지 톤과 어울려 자연스럽고 따뜻한 분위기를 연출합니다.",
            "Muted Clay": "흙빛이 감도는 차분한 컬러로 자연스럽고 안정적인 이미지를 줍니다.",
            "Warm Apricot": "상큼한 살구빛이 피부 톤을 밝혀주며 활기차고 따뜻한 분위기를 연출합니다.",
            "Peachy Pink": "러블리하고 발랄한 핑크 계열이 잘 어울리며, 생기 있고 유쾌한 느낌을 줍니다.",
            "Honey Buff": "꿀빛처럼 따뜻한 골드 베이지 계열로 건강하고 세련된 이미지를 보여줍니다.",
            "Beige Rose": "로즈빛이 감도는 베이지 계열로 우아하면서도 부드러운 매력을 살려줍니다."
        };

        const koreanNames = {
            "Golden": "골든 타입",
            "Warm Beige": "웜 베이지 타입",
            "Muted Clay": "뮤트 클레이 타입",
            "Warm Apricot": "웜 애프리콧 타입",
            "Peachy Pink": "피치 핑크 타입",
            "Honey Buff": "허니 버프 타입",
            "Beige Rose": "베이지 로즈 타입"
        };

        // --- Helper Functions ---
        function hexToHSL(hex) {
            hex = hex.replace(/^#/, '');
            let r = parseInt(hex.substring(0, 2), 16) / 255;
            let g = parseInt(hex.substring(2, 4), 16) / 255;
            let b = parseInt(hex.substring(4, 6), 16) / 255;

            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0;
            } else {
                let d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: h * 360, s: s * 100, l: l * 100 };
        }

        // --- Main DOM Logic ---
        const container = document.getElementById('color-guide-container');
        const template = document.getElementById('color-card-template');

        fetch("{{ url_for('static', filename='data/colors.json') }}")
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (!container || !template) {
                    console.error('Required elements not found in the DOM');
                    return;
                }

                for (const typeName in data) {
                    if (Object.hasOwnProperty.call(data, typeName)) {
                        const cardFragment = template.content.cloneNode(true);
                        const card = cardFragment.querySelector('.color-card');
                        const colorData = data[typeName];

                        // --- Header ---
                        const previewContainer = card.querySelector('.color-card-preview');
                        colorData.preview.forEach(color => {
                            const swatch = document.createElement('div');
                            swatch.className = 'swatch';
                            swatch.style.backgroundColor = color;
                            previewContainer.appendChild(swatch);
                        });

                        card.querySelector('.color-card-title h2').textContent = koreanNames[typeName] || typeName;
                        card.querySelector('.color-card-title p').textContent = descriptions[typeName] || '';

                        // --- Details ---
                        const detailsContainer = card.querySelector('.color-card-details');
                        for (const category in colorData) {
                            if (category === 'preview') continue;

                            const paletteDiv = document.createElement('div');
                            paletteDiv.className = 'detail-palette';

                            const title = document.createElement('h3');
                            title.textContent = category;
                            paletteDiv.appendChild(title);

                            const swatchesContainer = document.createElement('div');
                            swatchesContainer.className = 'detail-palette-swatches';

                            // ✅ Sort colors by hue first, then lightness (lightest → darkest)
                            const sortedColors = [...colorData[category]].sort((a, b) => {
                                const hslA = hexToHSL(a);
                                const hslB = hexToHSL(b);

                                if (Math.abs(hslA.h - hslB.h) > 5) {
                                    return hslA.h - hslB.h; // sort by hue
                                }
                                return hslB.l - hslA.l; // sort by lightness (ascending)
                            });

                            sortedColors.forEach(color => {
                                const swatch = document.createElement('div');
                                swatch.className = 'swatch';
                                swatch.style.backgroundColor = color;
                                swatch.dataset.color = color; // For tooltip or debugging
                                swatchesContainer.appendChild(swatch);
                            });

                            paletteDiv.appendChild(swatchesContainer);
                            detailsContainer.appendChild(paletteDiv);
                        }

                        container.appendChild(card);
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching or processing color data:', error);
                container.innerHTML = '<p style="text-align: center; color: #c44569;">컬러 가이드 정보를 불러오는 데 실패했습니다.</p>';
            });

        // Toggle open/close + copy swatch color
        container.addEventListener('click', (e) => {
            // 1) Toggle card open/close
            const header = e.target.closest('.color-card-header');
            if (header) {
                const card = header.parentElement;
                card.classList.toggle('open');
                return; // stop here so clicking header doesn't also trigger swatch copy
            }

            // 2) Copy color when swatch is clicked
            const swatch = e.target.closest('.swatch');
            if (swatch && swatch.dataset.color) {
                navigator.clipboard.writeText(swatch.dataset.color).then(() => {
                    // Optional feedback
                    swatch.classList.add("copied");
                    setTimeout(() => swatch.classList.remove("copied"), 800);
                }).catch(err => {
                    console.error("Clipboard copy failed:", err);
                });
            }
        });

    });
    </script>
</body>
</html>
